#!/usr/local/bin/python

from __future__ import print_function
from google_drive_concourse_resource_common import getServiceInstance
from google_drive_concourse_resource_common import listFilesinFolder
from google_drive_concourse_resource_common import getFile
from apiclient import errors
import json,sys

"""Takes a JSON request from stdin and downloads a file from google-drive onto a local folder
  Args:
    fID: Folder ID for the file to download
    fName: local Path to download the file to (including extension)
  Returns:
    File or exits(1) with a message indicating no file was retrieved
"""

fID=''
fName=''
cEmail=''
pID=''
cID=''
pKey=''

def main():
  req=json.load(sys.stdin)
  if req:
    #print(json.dumps(req),file=sys.stderr)
    fID=(req['source']['drive_folder_id'])
    fName=(req['version']['file_name'])
    cEmail=(req['source']['drive_client_email'])
    pID=(req['source']['drive_private_key_id'])
    cID=(req['source']['drive_client_id'])
    pKey=(req['source']['drive_private_key'])
  else:
    print('No suitable request received', file=sys.stderr)
    sys.exit(1)


  drive_service = getServiceInstance(cEmail,pID,cID,pKey)
  file=listFilesinFolder(drive_service,fID,fName)
  if file:
    response=getFile(drive_service,fID, file['id'], file['title'])
    if isinstance(response,errors.HttpError):
      print('File not retrieved',file=sys.stderr)
      sys.exit(1)
    else:
      metadata = []
      print(json.dumps({"version": {"path": file['title']},
                      "metadata": metadata
                      }))

  print('In ended',file=sys.stderr)

if __name__ == '__main__':
  main()
